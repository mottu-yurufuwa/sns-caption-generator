<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNSæŠ•ç¨¿æ–‡è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“± SNSæŠ•ç¨¿æ–‡è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h1>
            <p>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Instagramãƒ»Xï¼ˆTwitterï¼‰ãƒ»Threadsç”¨ã®æŠ•ç¨¿æ–‡ã‚’è‡ªå‹•ç”Ÿæˆ</p>
        </header>

        <main>
            <form id="uploadForm" class="upload-form">
                <div class="form-group">
                    <label for="image">ğŸ“¸ ç”»åƒã‚’é¸æŠ</label>
                    <input type="file" id="image" name="image" accept="image/png,image/jpeg,image/jpg" required>
                    <div class="file-info" id="fileInfo"></div>
                    <div class="image-preview" id="imagePreview">
                        <img id="previewImg" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ">
                    </div>
                </div>

                <div class="form-group">
                    <label for="mood">âœ¨ æŠ•ç¨¿ã®é›°å›²æ°—</label>
                    <div class="mood-input-container">
                        <select id="moodSelect" name="moodSelect">
                            <option value="">-- ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠ --</option>
                            <option value="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
                            <option value="ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹">ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹</option>
                            <option value="è©©çš„">è©©çš„</option>
                            <option value="ã‚¯ãƒ¼ãƒ«">ã‚¯ãƒ¼ãƒ«</option>
                            <option value="ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«">ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«</option>
                            <option value="ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«">ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«</option>
                            <option value="ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼</option>
                            <option value="ãƒ­ãƒãƒ³ãƒãƒƒã‚¯">ãƒ­ãƒãƒ³ãƒãƒƒã‚¯</option>
                            <option value="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒ†ã‚£ãƒƒã‚¯">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒ†ã‚£ãƒƒã‚¯</option>
                            <option value="ãƒŸãƒ‹ãƒãƒ«">ãƒŸãƒ‹ãƒãƒ«</option>
                        </select>
                        <div class="input-separator">ã¾ãŸã¯</div>
                        <input type="text" id="customMood" name="customMood" placeholder="è‡ªç”±ã«é›°å›²æ°—ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå¤ã‚‰ã—ãã¦çˆ½ã‚„ã‹ã€ãƒ¬ãƒˆãƒ­ã§ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒƒã‚¯ï¼‰">
                    </div>
                    <div class="mood-help">ğŸ’¡ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸ã¶ã‹ã€ãŠå¥½ã¿ã®é›°å›²æ°—ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„<br>â€»ãƒ—ãƒªã‚»ãƒƒãƒˆã§ç”Ÿæˆã™ã‚‹ã¨è‹±èªãŒå‡ºãªã„å¯èƒ½æ€§ãŒã”ã–ã„ã¾ã™ã€‚</div>
                </div>

                <div class="form-group">
                    <label for="languageOption">ğŸŒ è¨€èªè¨­å®š</label>
                    <select id="languageOption" name="languageOption">
                        <option value="japanese_only">æ—¥æœ¬èªã®ã¿</option>
                        <option value="japanese_english" selected>æ—¥æœ¬èª + è‹±èªç¿»è¨³</option>
                        <option value="english_only">è‹±èªã®ã¿</option>
                    </select>
                </div>

                <button type="submit" id="generateBtn" class="generate-btn">
                    ğŸš€ æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆã™ã‚‹
                </button>
            </form>

            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>AI ãŒç”»åƒã‚’åˆ†æä¸­...</p>
            </div>

            <div id="error" class="error hidden"></div>

            <div id="results" class="results hidden">
                <h2>ğŸ“ ç”Ÿæˆçµæœ</h2>
                
                <div class="image-analysis">
                    <h3>ğŸ” ç”»åƒåˆ†æçµæœ</h3>
                    <div class="content-box">
                        <p id="imageDescription"></p>
                    </div>
                </div>

                <div class="platform-results">
                    <div class="platform-card">
                        <div class="platform-header">
                            <h3>ğŸ“· Instagram</h3>
                        </div>
                        <div class="content-box">
                            <div class="caption-section">
                                <h4>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</h4>
                                <div class="text-content" id="instagramCaption"></div>
                                <button class="copy-btn" onclick="copyToClipboard('instagramCaption')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                            </div>
                            <div class="hashtags-section">
                                <h4>ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</h4>
                                <div class="hashtags" id="instagramHashtags"></div>
                                <button class="copy-btn" onclick="copyHashtags('instagramHashtags')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                            </div>
                        </div>
                    </div>

                    <div class="platform-card">
                        <div class="platform-header">
                            <h3>ğŸ¦ X (Twitter) ã‚¹ãƒ¬ãƒƒãƒ‰</h3>
                        </div>
                        <div class="content-box">
                            <div class="twitter-thread-container" id="twitterThreadContainer"></div>
                            <button class="copy-btn" onclick="copyTwitterThread()">ğŸ“‹ å…¨ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
                            <div class="thread-info" id="threadInfo"></div>
                        </div>
                    </div>

                    <div class="platform-card">
                        <div class="platform-header">
                            <h3>ğŸ§µ Threads</h3>
                        </div>
                        <div class="content-box">
                            <div class="platform-note">
                                ğŸ“ Instagramç”¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¨åŒã˜å†…å®¹ã§ã™
                            </div>
                            <div class="text-content" id="threadsContent"></div>
                            <button class="copy-btn" onclick="copyToClipboard('threadsContent')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                        </div>
                    </div>
                </div>

                <button class="reset-btn" onclick="resetForm()">ğŸ”„ æ–°ã—ã„ç”»åƒã§å†ç”Ÿæˆ</button>
            </div>
        </main>

        <footer>
            <p>Powered by OpenAI GPT-4o & Vision API</p>
        </footer>
    </div>

    <div id="toast" class="toast hidden">
        <span id="toastMessage"></span>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const fileInput = document.getElementById('image');
        const fileInfo = document.getElementById('fileInfo');

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.innerHTML = `<span class="file-name">${file.name}</span> <span class="file-size">(${fileSize}MB)</span>`;
                
                // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewImg = document.getElementById('previewImg');
                    const imagePreview = document.getElementById('imagePreview');
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const imageFile = document.getElementById('image').files[0];
            const moodSelect = document.getElementById('moodSelect').value;
            const customMood = document.getElementById('customMood').value.trim();
            const mood = customMood || moodSelect || 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«';
            const languageOption = document.getElementById('languageOption').value;

            if (!imageFile) {
                showError('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            formData.append('image', imageFile);
            formData.append('mood', mood);
            formData.append('language', languageOption);

            showLoading();

            try {
                console.log('Sending request to /api/generate');
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                // 500ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚’èª­ã¿å–ã‚‹
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                        console.log('Error data:', errorData);
                        throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}\nè©³ç´°: ${JSON.stringify(errorData, null, 2)}`);
                    } catch (parseError) {
                        console.log('Failed to parse error response:', parseError);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}\nRaw response: ${responseText}`);
                    }
                }

                const data = JSON.parse(responseText);
                console.log('Response data:', data);

                if (data.success) {
                    displayResults(data);
                } else {
                    showError(data.error || 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (err) {
                console.error('Error details:', err);
                showError(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            } finally {
                hideLoading();
            }
        });

        function showLoading() {
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            results.classList.add('hidden');
        }

        function hideLoading() {
            loading.classList.add('hidden');
        }

        function showError(message) {
            error.textContent = message;
            error.classList.remove('hidden');
        }

        function displayResults(data) {
            document.getElementById('imageDescription').textContent = data.image_description;
            document.getElementById('instagramCaption').textContent = data.captions.instagram.caption;
            document.getElementById('threadsContent').textContent = data.captions.threads;

            const hashtagsContainer = document.getElementById('instagramHashtags');
            if (data.captions.instagram.hashtags) {
                hashtagsContainer.innerHTML = data.captions.instagram.hashtags.map(tag => 
                    `<span class="hashtag">${tag}</span>`
                ).join(' ');
            }

            // Twitter ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤º
            const twitterContainer = document.getElementById('twitterThreadContainer');
            const threadInfo = document.getElementById('threadInfo');
            
            if (Array.isArray(data.captions.twitter)) {
                twitterContainer.innerHTML = data.captions.twitter.map((tweet, index) => 
                    `<div class="tweet-box">
                        <div class="tweet-header">ãƒ„ã‚¤ãƒ¼ãƒˆ ${index + 1}</div>
                        <div class="tweet-content">${tweet}</div>
                        <div class="tweet-actions">
                            <button class="copy-tweet-btn" onclick="copyToClipboard('tweet-${index}')" data-tweet="${tweet}">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                            <span class="tweet-char-count">${tweet.length}/140</span>
                        </div>
                        <div id="tweet-${index}" style="display: none;">${tweet}</div>
                     </div>`
                ).join('');
                threadInfo.innerHTML = `ğŸ“Š ã‚¹ãƒ¬ãƒƒãƒ‰æ•°: ${data.captions.twitter.length}å€‹ã®ãƒ„ã‚¤ãƒ¼ãƒˆ`;
            } else {
                // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
                twitterContainer.innerHTML = `
                    <div class="tweet-box">
                        <div class="tweet-header">ãƒ„ã‚¤ãƒ¼ãƒˆ 1</div>
                        <div class="tweet-content">${data.captions.twitter}</div>
                        <div class="tweet-actions">
                            <button class="copy-tweet-btn" onclick="copyToClipboard('tweet-0')" data-tweet="${data.captions.twitter}">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                            <span class="tweet-char-count">${data.captions.twitter.length}/140</span>
                        </div>
                        <div id="tweet-0" style="display: none;">${data.captions.twitter}</div>
                    </div>`;
                threadInfo.innerHTML = `ğŸ“Š ã‚¹ãƒ¬ãƒƒãƒ‰æ•°: 1å€‹ã®ãƒ„ã‚¤ãƒ¼ãƒˆ`;
            }

            results.classList.remove('hidden');
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }).catch(() => {
                showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        function copyHashtags(elementId) {
            const element = document.getElementById(elementId);
            const hashtags = Array.from(element.querySelectorAll('.hashtag')).map(tag => tag.textContent).join(' ');
            
            navigator.clipboard.writeText(hashtags).then(() => {
                showToast('ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }).catch(() => {
                showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        function copyTwitterThread() {
            const twitterContainer = document.getElementById('twitterThreadContainer');
            const tweets = Array.from(twitterContainer.querySelectorAll('.tweet-content')).map((tweet, index) => 
                `${index + 1}/${twitterContainer.querySelectorAll('.tweet-content').length} ${tweet.textContent}`
            ).join('\n\n');
            
            navigator.clipboard.writeText(tweets).then(() => {
                showToast('Twitterã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }).catch(() => {
                showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function resetForm() {
            uploadForm.reset();
            fileInfo.innerHTML = '';
            results.classList.add('hidden');
            error.classList.add('hidden');
            document.getElementById('customMood').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('previewImg').src = '';
        }
    </script>
</body>
</html>